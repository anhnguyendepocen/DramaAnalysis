---
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: 2
params:
  id: "test:rksp.0"
  col: "grey"
---

```{r,echo=FALSE}
pver <- packageVersion("DramaAnalysis")
```


```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (is.null(.Options$qd.datadir)) { 
  setup()
}

require(magrittr)

mtext <- loadSegmentedText(params$id)
meta <- loadMeta(params$id, type=atypes$Drama)
author <- loadMeta(params$id,type=atypes$Author)
title <- as.character(meta[1,"documentTitle"])
```

---
title: "QuaDramA Report: `r title`"

---

# Meta data

- Author(s): `r paste(paste0("[",author$Name,"](http://d-nb.info/gnd/",author$Pnd,")"),sep=", ")`

# Character Lists {.tabset}

## By Order of appearance

All figures, in the order they have their first appearance

```{r, echo=FALSE}
begins <- aggregate(mtext$begin, by=list(mtext$Speaker.figure_surface), min)
as.character(begins[order(begins$x),]$Group.1)
```

# Overall Speech Distribution

Relative amount of words spoken by each figure. 

```{r, echo=FALSE, messages=FALSE}
fstat <- figureStatistics(mtext, names=TRUE, normalize=FALSE)
mat <- figurematrix(fstat)
b <- barplot(mat$values,col=params$col)

top <- 15

text(x=b, y=t(head(mat$cs,top)+(head(mat$values,top)/2)),
     labels=t(substr(head(mat$labels,top),0,20)),cex=0.5)
```

# Presence and Utterances

```{r,echo=FALSE}
ustat <- utteranceStatistics(mtext, normalizeByDramaLength = FALSE, numberOfFigures = FALSE)

```

## All Utterances
```{r,echo=FALSE}
par(mar=c(1,9,1,0),xpd=FALSE)
plotUtterancePositions(ustat,mtext,xlab="")
```

## Utterance Length Variation

```{r,echo=FALSE}
par(mar=c(2,9,0,0))
boxplot(utteranceLength ~ figure, data=ustat, horizontal=TRUE,las=1,frame=FALSE)
```

# Configuration and Copresence {.tabset}

## By Act 
```{r, echo=FALSE}
c <- configuration(mtext)
c$matrix <- scale(c$matrix, center=FALSE, scale=colSums(c$matrix))
barplot(c$matrix, 
        legend.text=c$figure, # set legend text
        args.legend = list(cex=0.5, # legend font size
                           x=7.5, # legend x position
                           y=max(colSums(c$matrix)) # legend y pos
                        ),
        col=params$col)
```

## By Scene

```{r, echo=FALSE}
c <- configuration(mtext, by="Scene")
c$matrix <- scale(c$matrix, center=FALSE, scale=colSums(c$matrix))
barplot(c$matrix, 
        legend.text=c$figure, # set legend text
        args.legend = list(cex=0.5, # legend font size
                           x=7.5, # legend x position
                           y=max(colSums(c$matrix)) # legend y pos
                        ),
        col=params$col)
```


# Copresence Network
```{r, echo=FALSE, message=FALSE}
c <- configuration(mtext, onlyPresence = TRUE, by="Scene")
co <- c$matrix %*% t(c$matrix)

# add figure names
rownames(co) <- c$figure
colnames(co) <- c$figure
require(igraph)

g <- graph_from_adjacency_matrix(co, 
                                 weighted=TRUE,     # weighted graph
                                 mode="undirected", # no direction
                                 diag=FALSE         # no looping edges
                                )

# Now we plot
plot.igraph(g, 
            layout=layout_with_gem,       # how to lay out the graph
            vertex.label.cex=0.6,         # label size
            vertex.label.color="black",   # font color
            vertex.color=qd.colors[4],    # vertex color
            vertex.frame.color=NA,        # no vertex border
            edge.width=E(g)$weight        # scale edges according to their weight
            )  
```


# Word Fields  {.tabset}

## Bar Chart

```{r, echo=FALSE}
baseUrl <- "https://raw.githubusercontent.com/quadrama/metadata/ec8ae3ddd32fa71be4ea0e7f6c634002a002823d/fields/"

fieldNames <- c("Liebe", "Krieg", "Familie", "Ratio", "Religion")
fields <- loadFields(fieldNames,baseurl = baseUrl)

text2 <- limitFigures(mtext, by="tokens")
dstat <- dictionaryStatistics(
  text2,  # the text
  fields=fields,
  names = TRUE,                 # use figure names (instead of ids)
  normalizeByFigure = TRUE,   # normalization by figure
  normalizeByField = TRUE,    # normalization by field
  column = "Token.lemma"        # lemma-based stats
)
mat <- as.matrix(dstat[,4:8])
rownames(mat) <- vapply(strsplit(as.character(dstat$figure), ",", fixed=TRUE), `[`,1, FUN.VALUE=character(1))
par(mar=c(10,2,0,10),xpd=TRUE)
b <- barplot(t(mat), # we select Romeo's line
        col=params$col[1:length(fields)],
        las=3,
        border=FALSE
        )
legend(x=max(b)+1,y=max(mat),legend=colnames(mat),fill=params$col,bty="n",border=FALSE)

```

## Bar chart (z-scores)

[Z-scores in wikipedia](https://en.wikipedia.org/wiki/Standard_score)

```{r echo=FALSE}
zmat <- scale(as.matrix(dstat[,4:8]))

rownames(zmat) <- vapply(strsplit(as.character(dstat$figure), ",", fixed=TRUE), `[`,1, FUN.VALUE=character(1))
par(mar=c(2,12,0,6),xpd=TRUE)
b <- barplot(t(zmat), 
        col=params$col[1:length(fieldNames)],
        las=1,horiz=TRUE,
        border=FALSE,beside=TRUE
        )
legend(x=max(zmat),y=max(b)+1,legend=colnames(zmat),fill=params$col,bty="n",border=FALSE)

```


## Bar chart (scaled)

```{r, echo=FALSE}
mat <- t(scale(t(mat),center=FALSE,scale=rowSums(mat)))

par(mar=c(10,2,1,10),xpd=TRUE)
b <- barplot(t(mat),
        col=params$col[1:length(fields)],
        las=3,
        border=FALSE
        )
legend(x=max(b)+1,y=max(mat),legend=colnames(mat),fill=params$col,bty="n",border=FALSE)

```


## Spider Web

```{r, echo=FALSE}
plotSpiderWebs(dstat, col=params$col)
```

## Word fields

```{r, echo=FALSE}
fields
```

# Personnel Exchange

The following chart shows for each scene boundary the number of characters exchanged over the boundary. Different metrics have been proposd, the plot shows all of them in comparison.

```{r, echo=FALSE}
ham <- hamming(mtext)

if (length(ham)+1 != length(unique(mtext$begin.Scene))) {
  warning("Something is seriously wrong here. Please report this issue.")
}

par(mar=c(3,3,3,3))
layout(matrix(c(1,2,2,2,2),5,1,byrow=TRUE))
plot(0,type="n",axes=FALSE,xlab="",ylab="")
legend(x="center",lty=2:4,legend=c("Trilcke et al. (2017)", "Hamming (Normalized)", "Scenic Difference"),bty="n",horiz=TRUE)

sceneLabels <- paste(as.roman(mtext[,.N,.(Number.Act, Number.Scene)]$Number.Act), mtext[,.N,.(Number.Act, Number.Scene)]$Number.Scene, sep=".")
actBoundaries <- mtext[,length(unique(begin.Scene)),.(begin.Act)]$V1
s <- 0
for (i in 1:length(actBoundaries)) {
  actBoundaries[i] <- actBoundaries[i] + s
  s <- actBoundaries[i]
}



plot(0,type="n",axes=FALSE,xlab="Scene boundary",ylab="",
     ylim=c(0,1),
     xlim=c(1,length(ham)))
rect(0:(length(ham)),0,
     0:(length(ham))+1,1,
     border=NA,
     ylim=c(0,1),
     xlim=c(1,length(ham)),
     col=c(rgb(0.9,0.9,0.9,0.7),"white"))
axis(2, las=2)
#axis(1)
axis(1, at=0.5:(length(sceneLabels)),labels=sceneLabels, cex=0.1)
par(new=TRUE)
plot(x=1:length(ham),
     y=ham, type="l", 
     lty=2, 
     xlab="Scene boundary",ylab="",
     ylim=c(0,1),
     xlim=c(1,length(ham)),
     frame=FALSE,
     axes=FALSE)
abline(v=actBoundaries[1:(length(actBoundaries)-1)],xpd=FALSE,xlim=c(2,length(ham)))
par(new=TRUE)
plot(hamming(mtext, variant = "NormalizedHamming"), type="l", lty=3,xlab="",ylab="",axes=FALSE)
par(new=TRUE)
plot(scenicDifference(mtext), type="l",lty=4,axes=FALSE)

```

# About

This report has geen generated using the R package `DramaAnalysis` in version `r pver`. The package is being developed [here](http://github.com/quadrama/DramaAnalysis), in the context of the project [QuaDramA](https://quadrama.github.io). Please report errors [here](https://github.com/quadrama/DramaAnalysis/issues), or contact [me](mailto:nils.reiter@ims.uni-stuttgart.de).